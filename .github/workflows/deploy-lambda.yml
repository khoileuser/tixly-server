name: Deploy Lambda Function

on:
    push:
        branches: ["main"]
        paths:
            - "lambda/email-notification/**"
    workflow_dispatch:
    workflow_call:

env:
    AWS_REGION: us-east-1
    LAMBDA_FUNCTION_NAME: tixly-email-processor

jobs:
    deploy-lambda:
        name: Deploy Lambda Function
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"
                  cache-dependency-path: lambda/email-notification/package.json

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Install Lambda dependencies
              working-directory: lambda/email-notification
              run: |
                  echo "Installing production dependencies..."
                  npm ci --production

            - name: Create deployment package
              working-directory: lambda/email-notification
              run: |
                  echo "Creating Lambda deployment package..."
                  zip -r function.zip index.js package.json node_modules/
                  ls -lh function.zip

            - name: Check if CloudFormation stack exists
              id: check-stack
              run: |
                  if aws cloudformation describe-stacks --stack-name tixly-infrastructure 2>/dev/null; then
                    echo "stack_exists=true" >> $GITHUB_OUTPUT
                    echo "CloudFormation stack exists"
                  else
                    echo "stack_exists=false" >> $GITHUB_OUTPUT
                    echo "CloudFormation stack not found"
                  fi

            - name: Check if Lambda function exists
              id: check-lambda
              run: |
                  if aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} 2>/dev/null; then
                    echo "lambda_exists=true" >> $GITHUB_OUTPUT
                    echo "Lambda function exists"
                  else
                    echo "lambda_exists=false" >> $GITHUB_OUTPUT
                    echo "Lambda function not found"
                  fi

            - name: Wait for Lambda to be created
              if: steps.check-stack.outputs.stack_exists == 'true' && steps.check-lambda.outputs.lambda_exists == 'false'
              run: |
                  echo "CloudFormation stack exists but Lambda not ready yet..."
                  echo "Waiting for CloudFormation to finish creating Lambda function..."

                  max_attempts=30
                  attempt=0

                  while [ $attempt -lt $max_attempts ]; do
                    if aws lambda get-function --function-name ${{ env.LAMBDA_FUNCTION_NAME }} 2>/dev/null; then
                      echo "Lambda function is now available!"
                      echo "lambda_exists=true" >> $GITHUB_OUTPUT
                      exit 0
                    fi
                    attempt=$((attempt + 1))
                    echo "Attempt $attempt/$max_attempts - waiting 10 seconds..."
                    sleep 10
                  done

                  echo "Lambda function still not available after 5 minutes"
                  exit 1

            - name: Infrastructure not found error
              if: steps.check-stack.outputs.stack_exists == 'false'
              run: |
                  echo "ERROR: CloudFormation stack 'tixly-infrastructure' does not exist!"
                  echo ""
                  echo "Please run the infrastructure setup first:"
                  echo "  1. Go to Actions → 'Setup Infrastructure'"
                  echo "  2. Click 'Run workflow'"
                  echo "  3. Wait for infrastructure to be created"
                  echo ""
                  echo "Or run the full deployment workflow:"
                  echo "  Actions → 'Deploy Full Stack'"
                  exit 1

            - name: Update Lambda function code
              if: steps.check-lambda.outputs.lambda_exists == 'true' || steps.check-stack.outputs.stack_exists == 'true'
              working-directory: lambda/email-notification
              run: |
                  echo "Updating Lambda function code..."
                  aws lambda update-function-code \
                    --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
                    --zip-file fileb://function.zip \
                    --output json

            - name: Wait for Lambda update to complete
              if: steps.check-lambda.outputs.lambda_exists == 'true' || steps.check-stack.outputs.stack_exists == 'true'
              run: |
                  echo "Waiting for Lambda update..."
                  aws lambda wait function-updated --function-name ${{ env.LAMBDA_FUNCTION_NAME }}

            - name: Publish new version
              if: steps.check-lambda.outputs.lambda_exists == 'true' || steps.check-stack.outputs.stack_exists == 'true'
              id: publish-version
              run: |
                  echo "Publishing new Lambda version..."
                  VERSION=$(aws lambda publish-version \
                    --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
                    --description "Deployed from GitHub Actions - commit ${{ github.sha }}" \
                    --query 'Version' \
                    --output text)
                  echo "Published version: $VERSION"
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Deployment summary
              if: steps.check-lambda.outputs.lambda_exists == 'true' || steps.check-stack.outputs.stack_exists == 'true'
              run: |
                  echo "## Lambda Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- **Function**: \`${{ env.LAMBDA_FUNCTION_NAME }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Version**: \`${{ steps.publish-version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Region**: \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Deployment successful!" >> $GITHUB_STEP_SUMMARY
                  echo "Commit: ${{ github.sha }}"
